@page "/City"
@using BlazorApp2.Domain.Helpers
@using TravelingSalesmanWebApp.Data.Models
@using TravelingSalesmanWebApp.Data.Services
@inject ApplicationDBContext Context
@inject IClipboardService ClipboardService
@inject IUserSettingsRepository UserSettingsRepository

<MudText Typo="Typo.h1" Align="Align.Center">Города</MudText>

<MudStack Row="true" Class="d-flex align-center">
    <MudTextField @bind-Value="@UserSettingsRepository.LastEnteredCityName" Label="Введите название города" Variant="Variant.Filled"/>
    <MudIconButton Icon="@Icons.Material.Filled.Add" OnClick="Add"></MudIconButton>
</MudStack>
<MudStack Row="true" Class="d-flex align-center" Justify="Justify.Center">
    <MudIconButton Icon="@Icons.Material.Filled.Password" OnClick="ChangeIdVisibility"/>
    <MudToggleIconButton Icon="@Icons.Material.Filled.SyncDisabled" ToggledIcon="@Icons.Material.Filled.Sync" @bind-Toggled="@UserSettingsRepository.AutoSaveEnabled"/>
    @if (!UserSettingsRepository.AutoSaveEnabled)
    {
        <MudIconButton Icon="@Icons.Material.Filled.Save" OnClick="ForceSave"/>
    }
</MudStack>
<MudStack>
    @foreach (var item in Cities)
    {
        <MudStack Row="true" Class="d-flex align-center">
            @if (!UserSettingsRepository.CityIdHidden)
            {
                <MudTextField T="Guid" Variant="Variant.Outlined" Label="ID"
                              ReadOnly="true" @bind-Value="@item.Id"
                              Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.ContentCopy"
                              OnAdornmentClick="() => CopyToClipboardAsync(item.Id.ToString()).AndForget()"/>
            }
            <MudTextField T="string" Variant="Variant.Filled" Label="Название" @bind-Value="@item.Name" OnBlur="SaveChanges"/>
            <MudIconButton Icon="@Icons.Material.Filled.EditRoad" Href="@GetRefToPaths(item)"/>
            <MudIconButton Icon="@Icons.Material.Filled.RemoveCircle" OnClick="() => Remove(item)" Size="Size.Medium"/>
        </MudStack>
    }
    <MudDivider/>
</MudStack>

@code {
    private List<City> Cities;

    public void Add()
    {
        var city = new City { Name = UserSettingsRepository.LastEnteredCityName };
        Cities.Add(city);
        Context.Cities.Add(city);
        SaveChanges();
        UserSettingsRepository.LastEnteredCityName = string.Empty;
    }

    public void Remove(City city)
    {
        Context.Cities.Remove(city);
        Cities.Remove(city);
        SaveChanges();
    }

    public void SaveChanges()
    {
        if (UserSettingsRepository.AutoSaveEnabled)
            Context.SaveChangesAsync().AndForget();
    }

    private void ChangeIdVisibility()
    {
        UserSettingsRepository.CityIdHidden = !UserSettingsRepository.CityIdHidden;
        StateHasChanged();
    }

    private void ForceSave()
    {
        Context.SaveChangesAsync().AndForget();
    }

    private async Task CopyToClipboardAsync(string value)
    {
        await ClipboardService.WriteTextAsync(value);
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Cities = Context.Cities.ToList();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UserSettingsRepository.LoadLastStateAsync();
            StateHasChanged();
        }
        await base.OnAfterRenderAsync(firstRender);
    }

    private string GetRefToPaths(City city) => $"/Paths/{city.Id}";

}